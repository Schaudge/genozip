# ------------------------------------------------------------------
#   meta.template.yaml
#   Copyright (C) 2020 Divon Lan <divon@genozip.com>
#   Please see terms and conditions in the files LICENSE.non-commercial.txt and LICENSE.commercial.txt
#
# See: https://docs.conda.io/projects/conda-build/en/latest/resources/build-scripts.html
# See: https://docs.ligo.org/lscsoft/conda/packaging/
# Note: VERSION and SHA256 are replaced by Makefile
{% set version="VERSION" %}
#
# Example of building Windows with gcc: https://github.com/conda-forge/r-dplyr-feedstock/tree/master/recipe
{% set posix = 'm2-' if win else '' %}
{% set native = 'm2w64-' if win else '' %}

package:
  name: genozip
  version: {{ version }}

source:
  url: https://github.com/divonlan/genozip/archive/genozip-{{ version }}.tar.gz
  sha256: SHA256
 
build:
# Windows builds & tests successfully, but then the test fails in Appveyor - it seems the executable is not loading (maybe missing gcc libraries? just a hunch)
  skip: True  # [win]
  number: 0

requirements:
  build:    
# Example of a C project: https://github.com/conda-forge/bzip2-feedstock/tree/b49b6b5ecc0035d2e947a4e3f720a3f24519d19e/recipe
    - {{ compiler('c') }}        # [not win]
    - {{ compiler('m2w64_c') }}  # [win]
    - {{posix}}make
    - {{posix}}sed               # [win]
    - {{posix}}coreutils         # [win]
    - bzip2
  host:
    - {{native}}gcc-libs         # [win]
    - zlib
    - bzip2
  run:
    - {{native}}gcc-libs         # [win]
    - zlib
    - bzip2

test:
  source_files: 
    - test-file.vcf

  commands:
    {% set genozip_executables = [
      "genozip",
      "genounzip",
      "genocat",
      "genols"
    ] %}
    {% for executable in genozip_executables %}
    - test -f ${PREFIX}/bin/{{ executable }}  # [unix]
    {% endfor %}
    - which genozip.exe  # [win]
    - genozip --password abc --test test-file.vcf 2>&1  
  
about:
  home: https://github.com/divonlan/genozip
  dev_url: https://github.com/divonlan/genozip
# doc_url: https://genozip.readthedocs.io/
  license: CUSTOM
  license_family: OTHER
  license_file: 
    - LICENSE.non-commercial.txt
    - LICENSE.commercial.txt
  summary: Compressor for VCF genomic files, up to 5x better than gzip and faster too
  description: |
    genozip is a compressor for VCF genomic files (it compresses .vcf or .vcf.gz or .vcf.bz2 files). 
    It is very easy to use - in fact, if you're familiar with gzip, it works pretty much the same.
    It achieves x2 to x5 better compression ratios than gzip because it leverages some properties
    of the genomic data, such as linkage disequilibrium, to compress better. 
    It is also a lot faster than gzip. 
    The compression is lossless - the decompressed file is identical to the original file.
    Contact: info@genozip.com

extra:
  recipe-maintainers:
    - divonlan
